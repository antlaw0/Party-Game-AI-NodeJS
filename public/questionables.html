<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Questionables</title>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    .hidden { display: none; }
    .live-region { position: absolute; left: -9999px; height: 1px; width: 1px; overflow: hidden; }
    button { margin: 5px; }
  </style>
</head>
<body>

  <!-- NVDA Live Region -->
  <div id="liveRegion" class="live-region" aria-live="polite"></div>

  <!-- Game selection -->
  <div id="gameSetup">
    <h2>Questionables</h2>

    <div id="createSection">
      <h3>Create Game</h3>
      <label>Player Name: <input id="createName" type="text"></label><br>
      <label>Number of Rounds: <input id="numRounds" type="number" value="3" min="1"></label><br>
      <button id="createGameBtn">Create Game</button>
    </div>

    <div id="joinSection">
      <h3>Join Game</h3>
      <label>Player Name: <input id="joinName" type="text"></label><br>
      <label>Join Code: <input id="joinCode" type="text" maxlength="4"></label><br>
      <button id="joinGameBtn">Join Game</button>
    </div>
  </div>

  <!-- Lobby -->
  <div id="lobby" class="hidden">
    <h2>Lobby - <span id="lobbyCode"></span></h2>
    <h3>Players:</h3>
    <ul id="playerList"></ul>
    <button id="startGameBtn" class="hidden">Start Game</button>
  </div>

  <!-- Question -->
  <div id="questionStage" class="hidden">
    <h2>Round <span id="currentRound"></span></h2>
    <p id="prompt"></p>
    <label>Your Answer: <input id="answerInput" type="text"></label>
    <button id="submitAnswerBtn">Submit Answer</button>
    <p id="waitingAnswer" class="hidden">Waiting for others to answer...</p>
  </div>

  <!-- Voting -->
  <div id="votingStage" class="hidden">
    <h2>Vote!</h2>
    <p id="votingPrompt"></p>
    <div id="voteButtons"></div>
    <p id="waitingVote" class="hidden">Waiting for others to vote...</p>
  </div>

  <!-- Results -->
  <div id="resultsStage" class="hidden">
    <h2>Round Results</h2>
    <p id="resultsPrompt"></p>
    <ul id="resultsList"></ul>
    <button id="continueBtn" class="hidden">Continue</button>
  </div>

  <!-- Final Results -->
  <div id="finalResultsStage" class="hidden">
    <h2>Final Results</h2>
    <ul id="finalScores"></ul>
    <button id="returnHomeBtn">Return to Home</button>
  </div>

  <script>
    const socket = io();

    const liveRegion = document.getElementById('liveRegion');

    function announce(message) {
      liveRegion.textContent = message;
    }

    // Sections
    const gameSetup = document.getElementById('gameSetup');
    const createGameBtn = document.getElementById('createGameBtn');
    const joinGameBtn = document.getElementById('joinGameBtn');
    const lobby = document.getElementById('lobby');
    const playerList = document.getElementById('playerList');
    const lobbyCode = document.getElementById('lobbyCode');
    const startGameBtn = document.getElementById('startGameBtn');
    const questionStage = document.getElementById('questionStage');
    const currentRoundEl = document.getElementById('currentRound');
    const promptEl = document.getElementById('prompt');
    const answerInput = document.getElementById('answerInput');
    const submitAnswerBtn = document.getElementById('submitAnswerBtn');
    const waitingAnswer = document.getElementById('waitingAnswer');
    const votingStage = document.getElementById('votingStage');
    const votingPrompt = document.getElementById('votingPrompt');
    const voteButtons = document.getElementById('voteButtons');
    const waitingVote = document.getElementById('waitingVote');
    const resultsStage = document.getElementById('resultsStage');
    const resultsPrompt = document.getElementById('resultsPrompt');
    const resultsList = document.getElementById('resultsList');
    const continueBtn = document.getElementById('continueBtn');
    const finalResultsStage = document.getElementById('finalResultsStage');
    const finalScores = document.getElementById('finalScores');
    const returnHomeBtn = document.getElementById('returnHomeBtn');

    let myPlayerId;
    let isLeader = false;

    // Create Game
    createGameBtn.addEventListener('click', () => {
      const playerName = document.getElementById('createName').value.trim();
      const numRounds = parseInt(document.getElementById('numRounds').value, 10) || 3;
      if (!playerName) return alert('Enter a player name.');
      socket.emit('createGame', { playerName, numRounds });
    });

    // Join Game
    joinGameBtn.addEventListener('click', () => {
      const playerName = document.getElementById('joinName').value.trim();
      const joinCode = document.getElementById('joinCode').value.trim().toUpperCase();
      if (!playerName || !joinCode) return alert('Enter a name and join code.');
      socket.emit('joinGame', { playerName, joinCode });
    });

    // Lobby updates
    socket.on('gameCreated', ({ joinCode, players }) => {
      myPlayerId = socket.id;
      isLeader = true;
      gameSetup.classList.add('hidden');
      lobby.classList.remove('hidden');
      lobbyCode.textContent = joinCode;
      updateLobby(players);
      startGameBtn.classList.remove('hidden');
      announce(`Game created. Join code is ${joinCode}`);
    });
socket.on('gameJoined', ({ joinCode, players }) => {
  myPlayerId = socket.id;
  isLeader = false; // joined player is never leader
  gameSetup.classList.add('hidden');
  lobby.classList.remove('hidden');
  lobbyCode.textContent = joinCode;
  updateLobby(players);
  startGameBtn.classList.add('hidden'); // only leader sees this
  announce(`Joined game. Code is ${joinCode}`);
});

// --- updateLobby cleanup ---
function updateLobby(players) {
  playerList.innerHTML = '';
  players.forEach(p => {
    const li = document.createElement('li');
    li.textContent = p.name; // server already tags leader
    playerList.appendChild(li);
  });
}

socket.on('errorMsg', (msg) => {
  alert(msg);
});


    socket.on('updateLobby', (players) => {
      updateLobby(players);
    });

    function updateLobby(players) {
      playerList.innerHTML = '';
      players.forEach(p => {
        const li = document.createElement('li');
        li.textContent = p.name + (p.isLeader ? " (game leader)" : "");
        playerList.appendChild(li);
      });
    }

    startGameBtn.addEventListener('click', () => {
      socket.emit('startGame');
    });

    // Question stage
    socket.on('newQuestion', ({ round, prompt }) => {
      lobby.classList.add('hidden');
      resultsStage.classList.add('hidden');
      votingStage.classList.add('hidden');
      questionStage.classList.remove('hidden');

      currentRoundEl.textContent = round;
      promptEl.textContent = prompt;
      answerInput.value = '';
      answerInput.disabled = false;
      submitAnswerBtn.disabled = false;
      waitingAnswer.classList.add('hidden');

      announce(`Round ${round} question: ${prompt}`);
    });

    submitAnswerBtn.addEventListener('click', () => {
      const answer = answerInput.value.trim();
      if (!answer) return;
      socket.emit('submitAnswer', { answer });
      answerInput.disabled = true;
      submitAnswerBtn.disabled = true;
      waitingAnswer.classList.remove('hidden');
      announce('Answer submitted. Waiting for others.');
    });

    socket.on('waitingForPlayers', () => {
      waitingAnswer.classList.remove('hidden');
    });

    // Voting stage
    socket.on('startVoting', ({ prompt, answers }) => {
      questionStage.classList.add('hidden');
      votingStage.classList.remove('hidden');

      votingPrompt.textContent = prompt;
      voteButtons.innerHTML = '';
      waitingVote.classList.add('hidden');

      answers.forEach(a => {
        const btn = document.createElement('button');
        btn.textContent = a;
        btn.addEventListener('click', () => {
          socket.emit('submitVote', { answer: a });
          Array.from(voteButtons.children).forEach(b => b.disabled = true);
          waitingVote.classList.remove('hidden');
          announce(`You voted. Waiting for others.`);
        });
        voteButtons.appendChild(btn);
      });

      announce(`Voting started for question: ${prompt}`);
    });

    socket.on('waitingForVotes', () => {
      waitingVote.classList.remove('hidden');
    });

    // Round results
    socket.on('roundResults', ({ prompt, answers, round, totalRounds }) => {
      votingStage.classList.add('hidden');
      resultsStage.classList.remove('hidden');

      resultsPrompt.textContent = prompt;
      resultsList.innerHTML = '';
      answers.forEach(a => {
        const li = document.createElement('li');
        li.textContent = `${a.name}: ${a.answer} (${a.votes} votes)`;
        resultsList.appendChild(li);
      });

      if (isLeader) continueBtn.classList.remove('hidden');
      else continueBtn.classList.add('hidden');

      announce(`Round ${round} results displayed.`);
    });

    continueBtn.addEventListener('click', () => {
      socket.emit('continueGame');
    });

    // Final results
    socket.on('finalResults', ({ finalScores: scores }) => {
      resultsStage.classList.add('hidden');
      finalResultsStage.classList.remove('hidden');

      finalScores.innerHTML = '';
      scores.forEach(p => {
        const li = document.createElement('li');
        li.textContent = `${p.name}: ${p.score}`;
        finalScores.appendChild(li);
      });

      announce('Final scores displayed.');
    });

    returnHomeBtn.addEventListener('click', () => {
      finalResultsStage.classList.add('hidden');
      gameSetup.classList.remove('hidden');
    });
  </script>

</body>
</html>
